{% extends "base.html" %}
{% block title %}Student Search - AttendAI{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-2xl sm:text-3xl font-bold text-slate-800 mb-2">ğŸ” Student Search</h1>
        <p class="text-slate-500">Find student attendance records</p>
    </div>

    <!-- Search Box -->
    <div class="bg-white p-5 rounded-2xl shadow-xl mb-8">
        <div class="flex flex-col sm:flex-row gap-3">
            <div class="relative flex-grow">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">ğŸ”</span>
                <input type="text" id="search-input" placeholder="Search by Roll No or Name..."
                       class="w-full pl-11 pr-4 py-3.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base bg-slate-50">
            </div>
            <button id="search-btn" class="gradient-bg hover:opacity-90 text-white font-semibold py-3.5 px-8 rounded-xl transition-all shadow-lg hover:shadow-xl w-full sm:w-auto">
                Search
            </button>
        </div>
        
        <!-- Search Results Dropdown -->
        <div id="search-results" class="mt-3 bg-white border border-slate-200 rounded-xl shadow-lg max-h-60 overflow-y-auto hidden">
            <!-- Results will be injected here -->
        </div>
    </div>

    <!-- Student Dashboard Display Area -->
    <div id="dashboard-area">
        <div id="dashboard-placeholder" class="text-center py-16 bg-white rounded-2xl shadow-lg">
            <span class="text-5xl mb-4 block">ğŸ‘¤</span>
            <p class="text-slate-400 text-lg">Search for a student to view their dashboard</p>
            <p class="text-slate-300 text-sm mt-2">Enter roll number or name above</p>
        </div>
        <!-- Dashboard content will be loaded dynamically -->
    </div>
</div>

<script>
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    const searchResultsDiv = document.getElementById('search-results');
    const dashboardArea = document.getElementById('dashboard-area');
    const dashboardPlaceholder = document.getElementById('dashboard-placeholder');

    let searchTimeout;

    // --- Search Functionality ---
    const fetchSearchResults = async (query) => {
        if (query.length < 2) {
            searchResultsDiv.innerHTML = '';
            searchResultsDiv.classList.add('hidden');
            return;
        }

        const response = await fetch(`/api/search_student?q=${encodeURIComponent(query)}`);
        const results = await response.json();
        
        searchResultsDiv.innerHTML = '';
        if (results.length > 0 && !results.error) {
            results.forEach(student => {
                const item = document.createElement('div');
                item.className = 'p-4 hover:bg-indigo-50 cursor-pointer border-b border-slate-100 flex items-center gap-3 transition-colors';
                item.innerHTML = `
                    <div class="w-10 h-10 rounded-full gradient-bg flex items-center justify-center text-white font-bold">
                        ${student.name.charAt(0).toUpperCase()}
                    </div>
                    <div>
                        <div class="font-semibold text-slate-800">${student.name}</div>
                        <div class="text-sm text-slate-500">Roll No: ${student.roll_no}</div>
                    </div>
                `;
                item.setAttribute('data-rollno', student.roll_no);
                item.addEventListener('click', () => loadStudentDashboard(student.roll_no));
                searchResultsDiv.appendChild(item);
            });
            searchResultsDiv.classList.remove('hidden');
        } else {
            searchResultsDiv.innerHTML = '<div class="p-4 text-slate-500 text-center">No students found</div>';
            searchResultsDiv.classList.remove('hidden');
        }
    };
    
    // Trigger search on input change (with debounce)
    searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => fetchSearchResults(e.target.value), 300);
    });
    
    searchBtn.addEventListener('click', () => fetchSearchResults(searchInput.value));

    // --- Load Dashboard Functionality ---
    const loadStudentDashboard = async (rollNo) => {
        searchResultsDiv.classList.add('hidden');
        dashboardArea.innerHTML = `
            <div class="text-center py-16 bg-white rounded-2xl shadow-lg">
                <svg class="animate-spin h-10 w-10 mx-auto text-indigo-600 mb-4" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-indigo-600 font-medium">Loading student data...</p>
            </div>
        `;

        const response = await fetch(`/api/student_dashboard/${rollNo}`);
        const data = await response.json();
        
        if (response.ok && !data.error) {
            renderDashboard(data);
        } else {
            dashboardArea.innerHTML = `<div class="text-red-600 p-6 bg-red-50 rounded-2xl border border-red-200">âŒ Error: ${data.error || 'Unknown error'}</div>`;
        }
    };

    const renderDashboard = (data) => {
        const overall = data.overall_stats;
        const lectureWise = data.lecture_wise_stats;
        const dayWise = data.day_wise_stats;
        
        let monthlyHtml = '<h3 class="text-lg font-bold text-slate-800 mb-4">ğŸ“† Monthly Summary</h3>';
        
        if (data.monthly_stats.length > 0) {
             monthlyHtml += `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">`;
             data.monthly_stats.reverse().forEach(month => {
                const percentage = parseFloat(month.percentage);
                const color = percentage >= 75 ? 'green' : percentage >= 50 ? 'yellow' : 'red';
                monthlyHtml += `
                    <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-slate-800">${month.month}</span>
                            <span class="text-${color}-600 font-bold">${month.percentage}%</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2">
                            <div class="bg-${color}-500 h-2 rounded-full" style="width: ${month.percentage}%"></div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">${month.present_days} / ${month.total_days} lectures</p>
                    </div>
                `;
            });
            monthlyHtml += `</div>`;
        } else {
            monthlyHtml += '<p class="text-slate-400 text-center py-4">No monthly data available</p>';
        }

        dashboardArea.innerHTML = `
            <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl">
                <!-- Header -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4 pb-6 border-b border-slate-100">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-2xl gradient-bg flex items-center justify-center text-white text-2xl font-bold shadow-lg">
                            ${data.student_name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <h2 class="text-2xl sm:text-3xl font-bold text-slate-800">${data.student_name}</h2>
                            <p class="text-slate-500">Roll No: ${data.roll_no}</p>
                        </div>
                    </div>
                    <a href="/download_student_attendance/${data.roll_no}" 
                       class="gradient-bg hover:opacity-90 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition-all flex items-center gap-2 w-full sm:w-auto justify-center">
                        <span>ğŸ“¥</span> Download Report
                    </a>
                </div>
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                    <!-- Lecture-wise -->
                    <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 p-5 rounded-2xl border border-indigo-200">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-xl">ğŸ“š</span>
                            <span class="text-sm font-semibold text-indigo-700">Lecture-wise</span>
                        </div>
                        <p class="text-4xl font-extrabold text-indigo-900 mb-1">${lectureWise.percentage}%</p>
                        <p class="text-sm text-indigo-700">${lectureWise.attended_lectures} / ${lectureWise.total_lectures} lectures</p>
                    </div>
                    
                    <!-- Day-wise -->
                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-5 rounded-2xl border border-green-200">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-xl">ğŸ“…</span>
                            <span class="text-sm font-semibold text-green-700">Day-wise</span>
                        </div>
                        <p class="text-4xl font-extrabold text-green-900 mb-1">${dayWise.percentage}%</p>
                        <p class="text-sm text-green-700">${dayWise.present_days} / ${dayWise.total_days} days</p>
                    </div>

                    <!-- Overall -->
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-5 rounded-2xl border border-purple-200">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-xl">ğŸ“Š</span>
                            <span class="text-sm font-semibold text-purple-700">Overall</span>
                        </div>
                        <p class="text-4xl font-extrabold text-purple-900 mb-1">${overall.percentage}%</p>
                        <p class="text-sm text-purple-700">${overall.present_days} / ${overall.total_days} records</p>
                    </div>
                </div>

                <!-- Monthly Stats -->
                <div class="pt-6 border-t border-slate-100">
                    ${monthlyHtml}
                </div>
            </div>
        `;
    };
</script>
{% endblock %}
